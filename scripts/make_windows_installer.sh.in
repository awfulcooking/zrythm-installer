#!@BASH@

out_file="$1"

mingw_zrythm_pkg="$2"
zrythm_src_tarball="$3"
chroot_dir="$4"
gen_windows_installer_sh="$5"
inno_installer_iss="$6"
meson_src_root="$7"
private_dir="$"

inner_dir="@ZRYTHM_INNER_DIR_NAME@"
dash_trial="@DASH_TRIAL@"
zrythm_pkg_ver="@ZRYTHM_PKG_VERSION@"

tempdir=`mktemp -d -p @PRIVATE_DIR@`
tempdir2=`mktemp -d -p @PRIVATE_DIR@`

# create sources distribution
mkdir -p $tempdir/installer/dist/plugins
# add thirdparty version info
echo "TODO" > $tempdir/installer/dist/THIRDPARTY_INFO
# copy other files
tar xf $zrythm_src_tarball -C $tempdir2
zrythm_tmp_src_dir=$tempdir2/$inner_dir
installer_dir=$tempdir/installer
dist_dir=$installer_dir/dist
cp $zrythm_tmp_src_dir/AUTHORS $dist_dir/
cp $zrythm_tmp_src_dir/COPYING* $dist_dir/
cp $zrythm_tmp_src_dir/README.md $dist_dir/README.txt
cp $zrythm_tmp_src_dir/CONTRIBUTING.md $dist_dir/
cp $zrythm_tmp_src_dir/THANKS $dist_dir/
cp $zrythm_tmp_src_dir/TRANSLATORS $dist_dir/
cp $zrythm_tmp_src_dir/CHANGELOG.md $dist_dir/
cp $zrythm_tmp_src_dir/data/windows/zrythm.ico $dist_dir/zrythm.ico
#cp $(BUILD_DIR)/$(RCEDIT64_EXE) $(BUILD_WINDOWS_MSYS_DIR)/installer/
# copy plugins from the chroot dir
cp -R $chroot_dir/mingw64/lib/lv2/Z*.lv2 $dist_dir/plugins/
# remove some plugins if trial ver
if [ "$dash_trial" == "-trial" ]; then \
  rm -rf $dist_dir/plugins/ZChordz*.lv2 ; \
  rm -rf $dist_dir/plugins/ZLFO*.lv2 ; \
fi
# create installer
chmod +x $gen_windows_installer_sh
sed -i -e "s/sudo //g" $gen_windows_installer_sh
$gen_windows_installer_sh $chroot_dir/mingw64 \
  $zrythm_pkg_ver $installer_dir \
  $inno_installer_iss "Zrythm$dash_trial" \
  plugins "@BREEZE_DARK_PATH@" \
  "$meson_src_root/user-manual.zip" "$dash_trial"
cp "$dist_dir/Output/Zrythm$dash_trial $zrythm_pkg_ver.exe" $out_file
