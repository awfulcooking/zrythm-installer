# Maintainer: Alexandros Theodotou <alex at zrythm dot org>
_pkgbase=zrythm
MINGW_PACKAGE_PREFIX=mingw-w64
pkgname=$MINGW_PACKAGE_PREFIX-$_pkgbase
pkgver=0.8.459
pkgrel=2
arch=('any')
pkgdesc='a highly automated and intuitive digital audio workstation (mingw-w64)'
depends=("${MINGW_PACKAGE_PREFIX}-gtk3"
         "${MINGW_PACKAGE_PREFIX}-rubberband"
         "${MINGW_PACKAGE_PREFIX}-libsndfile"
         "${MINGW_PACKAGE_PREFIX}-libsamplerate"
         "${MINGW_PACKAGE_PREFIX}-gtksourceview4"
         "${MINGW_PACKAGE_PREFIX}-dlfcn"
         "${MINGW_PACKAGE_PREFIX}-fftw"
         "${MINGW_PACKAGE_PREFIX}-zstd"
         "${MINGW_PACKAGE_PREFIX}-libyaml")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-gettext"
             "guile"
             "${MINGW_PACKAGE_PREFIX}-meson"
             "${MINGW_PACKAGE_PREFIX}-pkg-config")
options=('!strip' 'staticlibs')
license=("AGPL3")
url="https://www.zrythm.org"
source=(https://www.zrythm.org/releases/zrythm-${pkgver}.tar.xz
  "diff.patch")
sha256sums=('SKIP' 'SKIP')
_architectures=('x86_64-w64-mingw32')

prepare() {
  cd "${srcdir}/${_pkgbase}-${pkgver}"
  pwd
  patch -Np1 -i ../diff.patch
}

build() {
  cd "${srcdir}/${_pkgbase}-${pkgver}"

  export NEED_WINE=1
  for _arch in "${_architectures[@]}"; do
    mkdir -p build-${_arch} && pushd build-${_arch}
    sed -i -e "s/'-lws2_32',/'-lws2_32', '-lssp',/" ../meson.build
    $_arch-meson \
      -Dsdl=disabled \
      -Drtaudio=auto \
      -Drtmidi=auto \
      -Djack=disabled \
      -Dguile=disabled \
      -Dwith-manpage=false \
      -Dwindows-release=true -Dcarla=disabled \
      --buildtype=release \
      --wrap-mode=forcefallback \
      ..
    sed -i -e '45s|#|//#|' ../subprojects/lilv/lilv-0.24.6/src/util.c
    sed -i -e '55s|#|//#|' ../subprojects/lilv/lilv-0.24.6/src/util.c
    ninja
    popd
  done
}

package() {
  export NEED_WINE=1
  for _arch in "${_architectures[@]}"; do
    DESTDIR="${pkgdir}" meson install -C ${srcdir}/${_pkgbase}-${pkgver}/build-${_arch}
  done
}
