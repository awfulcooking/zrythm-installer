#!@BASH@
#
# Copyright (C) 2020-2021 Alexandros Theodotou <alex at zrythm dot org>
#
# This file is part of Zrythm
#
# Zrythm is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Zrythm is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.

set -e

out_file="$1"

# chroot dir
chroot_dir="$2"

src_tarball="$3"

# full paths to each package (pkg.tar.zst) to install
packages="${@:4}"
packages_array=($packages)

dash_trial="@DASH_TRIAL@"

rm -rf $chroot_dir
mkdir -p $chroot_dir/var/lib/pacman
mkdir -p $chroot_dir/var/log
mkdir -p $chroot_dir/tmp
pacman -Syu --root $chroot_dir
pacman -S \
  filesystem bash pacman \
  --noconfirm --needed --root $chroot_dir
for pkg in "${packages_array[@]}"; do
  pacman -U "$pkg" --noconfirm --needed --root $chroot_dir
done
# verify plugins exist
ls -l $chroot_dir/mingw64/lib/lv2/Z*.lv2
pacman -S \
  mingw-w64-x86_64-gtksourceview4 \
  mingw-w64-x86_64-fftw \
  mingw-w64-x86_64-adwaita-icon-theme \
  --noconfirm --needed --root $chroot_dir
cp -R /mingw64/lib/carla "$chroot_dir/mingw64/lib/"
glib-compile-schemas.exe \
  "$chroot_dir/mingw64/share/glib-2.0/schemas"

cp $chroot_dir/mingw64/bin/zrythm.exe $chroot_dir/mingw64/bin/zrythm$dash_trial.exe || true

touch $out_file
