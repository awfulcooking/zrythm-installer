#!/bin/bash
#
# Copyright (C) 2019-2020 Alexandros Theodotou <alex at zrythm dot org>
#
#  This file is part of Zrythm
#
#  Zrythm is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  Zrythm is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.
#
#  You should have received a copy of the GNU Affero General Public License
#  along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.

set -e

zrythm="@ZRYTHM@"
zrythm_ver="@VERSION@"
zplugins="@ZPLUGINS@"
zplugins_ver="@ZPLUGINS_VERSION@"
architecture="amd64"

distro_ver=0
os_release_file=

if [ -e /etc/os-release ]; then
  . /etc/os-release
elif [ -e /usr/lib/os-release ]; then
  . /usr/lib/os-release
fi

# ---- Detect debian based systems ----
is_ubuntu=0
is_debian=0
is_mint=0
# LTS is version x.04
ubuntu_lts="04"

debian_10_str="Debian GNU/Linux 10"
debian_9_str="Debian GNU/Linux 9"
mint_19_3_str="LinuxMint 19.3"
ubuntu_18_04="Ubuntu 18.04"
ubuntu_18_10_str="Ubuntu 18.10"
ubuntu_19_10_str="Ubuntu 19.10"
ubuntu_20_04_str="Ubuntu 20.04"

zenity_width=360
have_zenity=0
command -v zenity
if [ $? -eq 0 ]; then
  have_zenity=1
fi

if [[ "$ID" = *"linuxmint"* ]]; then
  if [[ "$VERSION_ID" = *"19.3"* ]]; then
    echo "found $mint_19_3_str"
    is_mint=1
    distro_ver=19.3
  fi
fi

if [[ "$ID" = *"debian"* ]]; then
  if [[ "$VERSION_ID" = *"10"* ]]; then
    echo "found $debian_10_str"
    is_debian=1
    distro_ver=10
  elif [[ "$VERSION_ID" = *"9"* ]]; then
    echo "found $debian_9_str"
    is_debian=1
    distro_ver=9
  fi
fi

if [[ "$ID" = *"ubuntu"* ]]; then
  if [[ "$VERSION_ID" = *"18.04"* ]]; then
    echo "found $ubuntu_18_04_str"
    is_ubuntu=1
    distro_ver=18
    ubuntu_lts="04"
  elif [[ "$VERSION_ID" = *"18.10"* ]]; then
    echo "found $ubuntu_18_10_str"
    is_ubuntu=1
    distro_ver=18
    ubuntu_lts="10"
  elif [[ "$VERSION_ID" = *"20.04"* ]]; then
    echo "found $ubuntu_20_04_str"
    is_ubuntu=1
    distro_ver=20
    ubuntu_lts="04"
  elif [[ "$VERSION_ID" = *"19.10"* ]]; then
    echo "found $ubuntu_19_10_str"
    is_ubuntu=1
    distro_ver=19
    ubuntu_lts="10"
  fi
elif [[ "$ID_LIKE" = *"ubuntu"* ]]; then
  if [[ "$UBUNTU_CODENAME" = *"bionic"* ]]; then
    echo "found $ubuntu_18_04_str"
    is_ubuntu=1
    distro_ver=18
    ubuntu_lts="04"
  fi
fi

# ---- Detect arch systems ----

arch_str="Arch GNU/Linux"
is_arch=0

if [[ "$ID" = "arch" ]]; then
  echo "found $arch_str"
  architecture="x86_64"
  is_arch=1
elif [[ "$ID_LIKE" = *"arch"* ]]; then
  echo "found $arch_str"
  architecture="x86_64"
  is_arch=1
fi

# ---- Detect fedora/opensuse ----

is_fedora=0
is_opensuse=0
is_tumbleweed=0
fedora_30_str="Fedora 30"
fedora_31_str="Fedora 31"

if [[ "$ID" = "fedora" ]]; then
  architecture="x86_64"
  if [[ "$VERSION_ID" = *"31"* ]]; then
    echo "found $fedora_31_str"
    is_fedora=1
    distro_ver=31
  elif [[ "$VERSION_ID" = *"30"* ]]; then
    echo "found $fedora_30_str"
    is_fedora=1
    distro_ver=30
  fi
elif [[ "$ID" = "opensuse-tumbleweed" ]]; then
  is_opensuse=1
  is_tumbleweed=1
  architecture="x86_64"
fi

# ---- Install ----

show_error()
{
  if [ $have_zenity -ne 0 ]; then
    zenity --error --text="$1" --width $zenity_width
  else
    echo "$1"
  fi
}

show_info()
{
  if [ $have_zenity -ne 0 ]; then
    zenity --info --text="$1" --width $zenity_width
  else
    echo "$1"
  fi
}

if [ $is_ubuntu = 0 -a $is_debian = 0 -a $is_mint = 0 -a \
  $is_arch = 0 -a $is_fedora = 0 -a $is_tumbleweed = 0 ]; then
  show_error "Could not detect your distro or your distro is not supported yet. Please contact the Zrythm developers for assistance."
  exit 1
fi

ask_for_root_pw()
{
  ask_for_root_pw_text="Please enter your root password in the terminal to continue (if asked)"
  show_info "$ask_for_root_pw_text"
}

print_install_success()
{
  show_info "Install successful!"
}

proceed=0
proceed_txt="Proceed with the installation of Zrythm v$zrythm_ver?"
if [ $have_zenity -ne 0 ]; then
  zenity --question --text="$proceed_txt" --width $zenity_width
  if [ $? -eq 0 ]; then
    proceed=1
  fi
else
  read -p "$proceed_txt (type Y or y): " -n 1 -r
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    proceed=1
  fi
fi

if [ $proceed -ne 0 ]; then
  if [ $is_ubuntu = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "apt update && \
      dpkg -i \"bin/ubuntu/${zrythm}-${zrythm_ver}-1_${distro_ver}.${ubuntu_lts}_${architecture}.deb\" || \
      apt install -f -y" && \
      print_install_success
  elif [ $is_mint = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "apt update && \
      dpkg -i \"bin/linuxmint/${zrythm}-${zrythm_ver}-1_${distro_ver}_${architecture}.deb\" || \
      apt install -f -y" && \
      print_install_success
  elif [ $is_debian = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "apt update && \
      dpkg -i \"bin/debian/${zrythm}-${zrythm_ver}-1_${distro_ver}_${architecture}.deb\" || \
      apt install -f -y" && \
      print_install_success
  elif [ $is_fedora = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "dnf -y install \"bin/fedora/${zrythm}-${zrythm_ver}-1_${distro_ver}_${architecture}.rpm\"" && \
      print_install_success
  elif [ $is_tumbleweed = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "zypper -in install --allow-unsigned-rpm \"bin/opensuse/${zrythm}-${zrythm_ver}-1_tumbleweed_${architecture}.rpm\"" && \
      print_install_success
  elif [ $is_arch = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "pacman -U --noconfirm \"bin/arch/${zrythm}-${zrythm_ver}-1_${architecture}.pkg.tar.xz\"" && \
      print_install_success
  fi
fi

proceed=0
proceed_txt="Proceed with the installation of ZPlugins v$zplugins_ver?"
if [ $have_zenity -ne 0 ]; then
  zenity --question --text="$proceed_txt" --width $zenity_width
  if [ $? -eq 0 ]; then
    proceed=1
  fi
else
  read -p "$proceed_txt (type Y or y): " -n 1 -r
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    proceed=1
  fi
fi

if [ $proceed -ne 0 ]; then
  if [ $is_ubuntu = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/ubuntu/${zplugins}-${distro_ver}.${ubuntu_lts}/\"* /usr/lib/lv2/" && \
      print_install_success
  elif [ $is_mint = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/linuxmint/${zplugins}-${distro_ver}/\"* /usr/lib/lv2/" && \
      print_install_success
  elif [ $is_debian = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/debian/${zplugins}-${distro_ver}/\"* /usr/lib/lv2/" && \
      print_install_success
  elif [ $is_fedora = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/fedora/${zplugins}-${distro_ver}/\"* /usr/lib64/lv2/" && \
      print_install_success
  elif [ $is_tumbleweed = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/opensuse/${zplugins}-tumbleweed/\"* /usr/lib64/lv2/" && \
      print_install_success
  elif [ $is_arch = 1 ]; then
    ask_for_root_pw;
    sudo /bin/sh -c \
      "cp -R \"bin/arch/${zplugins}-arch/\"* /usr/lib/lv2/" && \
      print_install_success
  fi
fi
