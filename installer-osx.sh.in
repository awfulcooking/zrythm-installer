#!/bin/bash
#
# Copyright (C) 2020 Alexandros Theodotou <alex at zrythm dot org>
#
#  This file is part of Zrythm
#
#  Zrythm is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  Zrythm is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.
#
#  You should have received a copy of the GNU Affero General Public License
#  along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.

set -e

zrythm_ver="@VERSION@"
zplugins_ver="@ZPLUGINS_VERSION@"

show_error () {
  echo "$1" >&2
  exit 1
}

show_info () {
  echo "$1"
}

if ! [ -x "$(command -v brew)" ]; then
  echo 'Error: brew is not installed. install it?'
  read -p "$proceed_txt (type Y or y): " -n 1 -r
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
  else
    show_error "Homebrew is necessary to install zrythm"
  fi
fi

print_install_success()
{
  show_info "Install successful! Type 'zrythm --version' to verify"
}

proceed=0
proceed_txt="Proceed with the installation of Zrythm v$zrythm_ver?"
read -p "$proceed_txt (type Y or y): " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
  proceed=1
fi

# install packages
if [ $proceed -ne 0 ]; then
  echo "Unpacking..."
  tar xf bin/carla-git*.catalina.bottle.tar.gz -C /usr/local/Cellar
  brew unlink carla-git || true
  brew unlink zrythm || true
  brew unlink zrythm-trial || true
  tar xf bin/zrythm*.catalina.bottle.tar.gz -C /usr/local/Cellar

  # link
  echo "Linking..."
  brew link carla-git
  brew link --overwrite zrythm@TRIAL@

  # install deps
  echo "Installing deps..."
  zrythm_deps="$(brew info zrythm@TRIAL@ | grep Required | sed -e "s/Required: //" | sed -e "s/, / /g" | sed -e "s/carla-git//")"
  carla_deps="$(brew info carla-git | grep Required | sed -e "s/Required: //" | sed -e "s/, / /g")"
  brew install $carla_deps
  brew install $zrythm_deps

  # fix paths
  echo "Fixing paths..."
  exe_path="$(dirname /usr/local/bin/zrythm)/$(readlink /usr/local/bin/zrythm)"
  chmod +w $exe_path
  for exe in $exe_path; do
    echo "processing executable $exe"
    changes=""
    for lib in `otool -L $exe | egrep "@@HOMEBREW_PREFIX@@" | awk '{print $1}'` ; do
      replaced=`echo "$lib" | sed -e "s,@@HOMEBREW_PREFIX@@,/usr/local,g"`
      changes="$changes -change $lib $replaced"
    done
    if test "x$changes" != "x" ; then
      install_name_tool $changes $exe
    fi
  done
  chmod -w $exe_path

  # recompile schemas
  echo "Recompiling schemas..."
  /usr/local/bin/glib-compile-schemas /usr/local/share/glib-2.0/schemas

  print_install_success
fi

exit 0

proceed=0
proceed_txt="Proceed with the installation of ZPlugins v$zplugins_ver?"
read -p "$proceed_txt (type Y or y): " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
  proceed=1
fi

# install plugins
if [ $proceed -ne 0 ]; then
  print_install_success
fi
